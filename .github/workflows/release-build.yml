name: Release Builds (Win + Linux)

on:
  push:
    branches: [ main ]

env:
  # Qt 6.7.3 is available on online installers and works with MSVC 2019/2022 toolchains
  QT_VERSION: 6.7.3
  QT_ARCH: win64_msvc2019_64
  BUILD_DIR: build

jobs:
  tests-linux:
    runs-on: ubuntu-22.04
    env:
      QT_VERSION: 6.7.3
      QT_ARCH: linux_gcc_64
      BUILD_DIR: build-tests
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          arch: ${{ env.QT_ARCH }}
          cache: true

      - name: Install Qt test runtime deps
        run: sudo apt-get update && sudo apt-get install -y libxcb-cursor0

      - name: Configure tests (qmake, release)
        run: |
          mkdir -p $BUILD_DIR
          cd $BUILD_DIR
          qmake -config release ../src/QtScintellion/QtScintellion.pro

      - name: Build tests
        run: |
          cd $BUILD_DIR
          make -j2 sub-QtScintellionTests

      - name: Run tests
        run: |
          cd $BUILD_DIR/QtScintellionTests
          QT_QPA_PLATFORM=offscreen ./QtScintellionTests

  tests-windows:
    runs-on: windows-latest
    env:
      QT_VERSION: 6.7.3
      QT_ARCH: win64_msvc2019_64
      BUILD_DIR: build-tests
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute version (yy.m.d)
        id: meta_tests
        shell: pwsh
        run: |
          $ver = Get-Date -Format 'yy.M.d'
          "version=$ver" >> $env:GITHUB_OUTPUT

      - name: Set up MSVC environment
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          arch: ${{ env.QT_ARCH }}
          cache: true

      - name: Configure tests (qmake, release)
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path $env:BUILD_DIR | Out-Null
          Push-Location $env:BUILD_DIR
          qmake -config release ..\src\QtScintellion\QtScintellion.pro
          Pop-Location

      - name: Build tests
        shell: pwsh
        run: |
          Push-Location $env:BUILD_DIR
          nmake /S sub-QtScintellionTests
          Pop-Location

      - name: Run tests
        shell: pwsh
        run: |
          $candidates = @(
            (Join-Path $env:BUILD_DIR "QtScintellionTests/QtScintellionTests.exe"),
            (Join-Path $env:BUILD_DIR "QtScintellionTests/release/QtScintellionTests.exe")
          )
          foreach ($p in $candidates) {
            if (Test-Path $p) {
              & $p -platform offscreen
              exit $LASTEXITCODE
            }
          }
          Write-Error ("Test exe not found. Checked: " + ($candidates -join ', '))

  build-and-release-windows:
    needs: [tests-linux, tests-windows]
    runs-on: windows-latest
    permissions:
      contents: write
    outputs:
      version: ${{ steps.meta.outputs.version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute version (yy.m.d)
        id: meta
        shell: pwsh
        run: |
          $ver = Get-Date -Format 'yy.M.d'
          "version=$ver" >> $env:GITHUB_OUTPUT

      - name: Set up MSVC environment
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          arch: ${{ env.QT_ARCH }}
          cache: true

      - name: Configure (qmake, release)
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path $env:BUILD_DIR | Out-Null
          Push-Location $env:BUILD_DIR
          qmake -config release ..\src\QtScintellion\QtScintellion.pro
          Pop-Location

      - name: Build (Release)
        shell: pwsh
        run: |
          Push-Location $env:BUILD_DIR
          nmake /S
          Pop-Location

      - name: Deploy Qt dependencies (windeployqt)
        shell: pwsh
        run: |
          $exePath = Join-Path $env:BUILD_DIR "QtScintellionUI/release/QtScintellionUI.exe"
          if (-not (Test-Path $exePath)) {
            Write-Error "Executable not found at $exePath"
          }
          $windeploy = Join-Path $env:Qt6_DIR "bin/windeployqt.exe"
          & $windeploy --release --no-translations "$exePath"

      - name: Package zip
        shell: pwsh
        run: |
          $version = "${{ steps.meta.outputs.version }}"
          $zipName = "QtScintellion-Windows-$version.zip"
          $payloadRoot = Join-Path $env:BUILD_DIR "QtScintellionUI/release"
          if (-not (Test-Path $payloadRoot)) {
            Write-Error "Payload root not found: $payloadRoot"
          }
          Compress-Archive -Path (Join-Path $payloadRoot '*') -DestinationPath $zipName -Force
          "asset=$zipName" >> $env:GITHUB_OUTPUT
        id: package

      - name: Delete existing release/tag if present
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const version = '${{ steps.meta.outputs.version }}';
            const tag = version;
            // Delete release if exists
            try {
              const rel = await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag
              });
              await github.rest.repos.deleteRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: rel.data.id,
              });
            } catch (err) {
              if (![404, 403].includes(err.status)) throw err;
            }
            // Delete tag if exists
            try {
              await github.rest.git.deleteRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `tags/${tag}`,
              });
            } catch (err) {
              if (![404, 403].includes(err.status)) throw err;
            }

      - name: Create release and upload asset (Windows)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.version }}
          name: ${{ steps.meta.outputs.version }}
          files: ${{ steps.package.outputs.asset }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-and-release-linux:
    needs: build-and-release-windows
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    env:
      QT_VERSION: 6.7.3
      QT_ARCH: linux_gcc_64
      BUILD_DIR: build-linux

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute version (from Windows job)
        id: meta
        run: echo "version=${{ needs.build-and-release-windows.outputs.version }}" >> $GITHUB_OUTPUT

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          arch: ${{ env.QT_ARCH }}
          cache: true

      - name: Install deploy deps
        run: sudo apt-get update && sudo apt-get install -y libxcb-cursor0

      - name: Install linuxdeployqt deps
        run: sudo apt-get update && sudo apt-get install -y patchelf

      - name: Configure (qmake, release)
        run: |
          mkdir -p $BUILD_DIR
          cd $BUILD_DIR
          qmake -config release ../src/QtScintellion/QtScintellion.pro

      - name: Build (Release)
        run: |
          cd $BUILD_DIR
          make -j2

      - name: Bundle with linuxdeployqt
        run: |
          cd $BUILD_DIR
          curl -L https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage -o linuxdeployqt
          chmod +x linuxdeployqt
          # Remove unavailable SQL driver (mimer) to avoid missing libmimerapi.so during bundling.
          if [ -f "$Qt6_DIR/plugins/sqldrivers/libqsqlmimer.so" ]; then
            rm "$Qt6_DIR/plugins/sqldrivers/libqsqlmimer.so"
          fi
          APP_DIR=QtScintellionUI
          EXE=QtScintellionUI/QtScintellionUI
          if [ ! -f "$EXE" ]; then
            echo "Executable not found at $EXE" >&2
            exit 1
          fi
          ./linuxdeployqt "$EXE" -bundle-non-qt-libs

      - name: Package tar.gz
        id: package
        run: |
          version=${{ steps.meta.outputs.version }}
          tarName="QtScintellion-Linux-$version.tar.gz"
          tar -czf "$tarName" -C $BUILD_DIR QtScintellionUI
          echo "asset=$tarName" >> $GITHUB_OUTPUT

      - name: Upload asset to release (Linux)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.build-and-release-windows.outputs.version }}
          name: ${{ needs.build-and-release-windows.outputs.version }}
          files: ${{ steps.package.outputs.asset }}
          fail_on_unmatched_files: true
          append_body: true
          allowUpdates: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
